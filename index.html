<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify AI Content Pro - Team Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 1rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .loading-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .image-grid-item { aspect-ratio: 3/4; overflow: hidden; position: relative; border-radius: 0.75rem; background: #f9fafb; }
        .image-grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .image-grid-item:hover .image-overlay { opacity: 1; }
    </style>
</head>
<body class="text-slate-900 pb-20">

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Top Navigation / Settings -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-rocket text-indigo-600"></i> Shopify Content Pro
                </h1>
                <p class="text-slate-500 text-xs">团队协作版 · 支持自定义 API 中转与双语生成</p>
            </div>
            <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-cog text-xl"></i>
            </button>
        </header>

        <!-- API Settings Panel (Hidden by default) -->
        <div id="settingsPanel" class="hidden mb-6 p-6 card border-indigo-100 bg-indigo-50/50">
            <h3 class="text-sm font-bold text-indigo-900 mb-4 flex items-center gap-2">
                <i class="fas fa-key"></i> 团队接口配置
            </h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-1">API Key</label>
                    <input id="apiKeyInput" type="password" placeholder="输入您的 Gemini API Key..." class="w-full px-4 py-2 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-1">API Proxy Base URL (可选)</label>
                    <input id="apiBaseInput" type="text" placeholder="默认: https://generativelanguage.googleapis.com" class="w-full px-4 py-2 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                    <p class="mt-1 text-[10px] text-indigo-400">使用第三方中转站时请填写，否则留空。</p>
                </div>
                <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition-colors">保存配置</button>
            </div>
        </div>

        <!-- Main Input -->
        <div class="card p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <label class="block text-sm font-bold text-slate-700">1. 产品视觉素材</label>
                    <div id="dropZone" class="flex items-center justify-center w-full">
                        <label for="imageInput" class="flex flex-col items-center justify-center w-full h-44 border-2 border-slate-200 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 transition-all group">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center px-4" id="uploadPlaceholder">
                                <i class="fas fa-cloud-upload-alt text-3xl text-slate-300 group-hover:text-indigo-500 mb-2 transition-colors"></i>
                                <p class="text-xs text-slate-400 font-medium">点击上传、拖入或粘贴截图</p>
                            </div>
                            <input id="imageInput" type="file" class="hidden" accept="image/*" multiple />
                        </label>
                    </div>
                    <div id="imagePreviews" class="flex gap-2 overflow-x-auto no-scrollbar py-1"></div>
                </div>

                <div class="space-y-4">
                    <label class="block text-sm font-bold text-slate-700">2. 补充需求 (Prompt Notes)</label>
                    <textarea id="rawInput" rows="5" placeholder="例如：
- 品牌名: UrbanLoft
- 面料: 100% 重磅精梳棉
- 卖点: 显瘦，适合梨形身材" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm leading-relaxed"></textarea>
                    
                    <button id="generateBtn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg shadow-slate-200 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-sparkles"></i>
                        <span>生成全套双语方案</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Error & Loading -->
        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm flex items-center gap-2">
            <i class="fas fa-exclamation-circle"></i><span id="errorText"></span>
        </div>
        <div id="loading" class="hidden space-y-6">
            <div class="loading-shimmer h-32 rounded-xl"></div>
            <div class="loading-shimmer h-64 rounded-xl"></div>
        </div>

        <!-- Result Output -->
        <div id="output" class="hidden space-y-8">
            <!-- Action Bar -->
            <div class="flex justify-end gap-3">
                <button onclick="exportData()" class="text-xs font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-1">
                    <i class="fas fa-file-export"></i> 导出 JSON
                </button>
            </div>

            <!-- SEO Block -->
            <section class="card overflow-hidden border-indigo-100">
                <div class="bg-indigo-600 px-6 py-3 flex justify-between items-center">
                    <h3 class="text-xs font-black text-white uppercase tracking-tighter">SEO Meta Tags</h3>
                    <button onclick="copyElementText('seoEnContainer', this)" class="text-[10px] bg-white/20 text-white px-2 py-1 rounded hover:bg-white/30 transition-colors">Copy English</button>
                </div>
                <div class="p-6 space-y-4" id="seoEnContainer">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">SEO Title</label>
                        <div id="seoTitle" class="text-sm font-semibold text-slate-800 border-b border-slate-50 pb-2"></div>
                        <div id="seoTitleZh" class="text-[11px] text-slate-400 mt-1 italic"></div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Meta Description</label>
                        <div id="seoDesc" class="text-sm text-slate-600 leading-snug border-b border-slate-50 pb-2"></div>
                        <div id="seoDescZh" class="text-[11px] text-slate-400 mt-1 italic"></div>
                    </div>
                </div>
            </section>

            <!-- Titles Grid -->
            <div id="titleContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

            <!-- Product Description -->
            <section class="card overflow-hidden">
                <div class="bg-slate-800 px-6 py-3 flex justify-between items-center">
                    <h3 class="text-xs font-black text-white uppercase tracking-tighter">Product Description</h3>
                    <button onclick="copyElementText('descFullEn', this)" class="text-[10px] bg-white/20 text-white px-2 py-1 rounded hover:bg-white/30">Copy English</button>
                </div>
                <div class="p-6">
                    <div id="descFullEn" class="text-sm text-slate-700 leading-relaxed space-y-4"></div>
                    <div id="descFullZh" class="mt-6 pt-6 border-t border-slate-100 text-[13px] text-slate-400 italic space-y-3"></div>
                </div>
            </section>

            <!-- Colors -->
            <div id="colorContainer" class="flex flex-wrap gap-4"></div>

            <!-- UGC Gallery -->
            <section class="pt-8 border-t border-slate-200">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-sm font-bold text-slate-800 uppercase tracking-tight">Consistent UGC Photos</h3>
                        <p class="text-[10px] text-slate-400">基于产品原图生成的买家秀图库</p>
                    </div>
                    <button id="generateUgcBtn" class="bg-indigo-600 text-white px-6 py-2.5 rounded-full text-xs font-bold shadow-md hover:bg-indigo-700 transition-all flex items-center gap-2">
                        <i class="fas fa-camera"></i> 生成所有买家秀
                    </button>
                </div>
                <div id="ugcGrid" class="grid grid-cols-2 md:grid-cols-5 gap-3"></div>
                <div id="ugcStatus" class="mt-4 text-[10px] text-slate-400 text-center italic hidden"></div>
            </section>
        </div>
    </div>

    <script>
        // --- State & Settings ---
        let currentData = null;
        let uploadedImages = [];
        let ugcPrompts = [];

        // 初始化加载配置
        window.onload = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            const savedBase = localStorage.getItem('api_base_url');
            if (savedKey) document.getElementById('apiKeyInput').value = savedKey;
            if (savedBase) document.getElementById('apiBaseInput').value = savedBase;
        };

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function saveSettings() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const base = document.getElementById('apiBaseInput').value.trim();
            if (!key) return alert("请输入 API Key");
            
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('api_base_url', base);
            toggleSettings();
            alert("配置已更新！");
        }

        function getApiKey() {
            return localStorage.getItem('gemini_api_key') || "";
        }

        function getApiBase() {
            let base = localStorage.getItem('api_base_url') || "https://generativelanguage.googleapis.com";
            if (base.endsWith('/')) base = base.slice(0, -1);
            return base;
        }

        // --- Core UI Logic ---
        const imageInput = document.getElementById('imageInput');
        const imagePreviews = document.getElementById('imagePreviews');
        const generateBtn = document.getElementById('generateBtn');

        imageInput.onchange = e => Array.from(e.target.files).forEach(processFile);
        document.addEventListener('paste', e => {
            const items = e.clipboardData.items;
            for (const item of items) if (item.type.includes('image')) processFile(item.getAsFile());
        });

        function processFile(file) {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImages.push({ base64: e.target.result.split(',')[1], mimeType: file.type });
                updatePreviews();
            };
            reader.readAsDataURL(file);
        }

        function updatePreviews() {
            document.getElementById('uploadPlaceholder').classList.toggle('hidden', uploadedImages.length > 0);
            imagePreviews.innerHTML = uploadedImages.map((img, i) => `
                <div class="relative w-20 h-20 rounded-xl overflow-hidden border-2 border-slate-100 shrink-0 shadow-sm">
                    <img src="data:${img.mimeType};base64,${img.base64}" class="w-full h-full object-cover">
                    <button onclick="uploadedImages.splice(${i},1);updatePreviews();" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center rounded-bl-lg text-[10px]">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- AI Prompt Engineering ---
        const systemPrompt = `You are a high-end Shopify Copywriter.
Goal: Generate bilingual product content (EN/ZH) based on images.

Requirement for 'Product Description':
1. STRICTLY follow the structure:
   - Paragraph: A vivid, narrative description (50-70 words) focusing on silhouette, drapes, and fabric feel. 
   - Fabric Section: Key fabric features separated by semicolons.
   - Model Info Section: Realistic size info.
2. English Output must be professional, native-level.
3. Chinese Output must be natural for domestic review.

JSON Response:
{
  "seo": { "en_t": "...", "zh_t": "...", "en_d": "...", "zh_d": "..." },
  "titles": [{"label": "Fashion/SEO", "en": "...", "zh": "..."}],
  "desc": {
    "en_m": "Paragraph content...",
    "en_f": "Fabric features...",
    "en_i": "Model info...",
    "zh_m": "中文描述...",
    "zh_f": "中文面料...",
    "zh_i": "中文模特..."
  },
  "colors": [{"en": "...", "zh": "..."}],
  "ugc": [{"ethnicity": "...", "prompt": "Image-to-image prompt"}]
}`;

        // --- Network Logic ---
        async function apiCall(model, payload) {
            const key = getApiKey();
            const base = getApiBase();
            if (!key) throw new Error("API Key 缺失。请点击设置图标配置。");

            // 拼接中转或官方地址
            const url = `${base}/v1beta/models/${model}:generateContent?key=${key}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (!res.ok) throw new Error(data.error?.message || "网络请求失败");
            return data;
        }

        generateBtn.onclick = async () => {
            if (uploadedImages.length === 0) return alert("请先上传产品图片");
            
            generateBtn.disabled = true;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('output').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            const parts = [{ text: document.getElementById('rawInput').value.trim() || "Analyze this product." }];
            uploadedImages.forEach(img => parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } }));

            try {
                const data = await apiCall('gemini-2.5-flash-preview-09-2025', {
                    contents: [{ parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                });

                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                currentData = result;
                ugcPrompts = result.ugc || [];
                renderResult(result);
            } catch (err) {
                document.getElementById('errorText').innerText = err.message;
                document.getElementById('errorMessage').classList.remove('hidden');
            } finally {
                generateBtn.disabled = false;
                document.getElementById('loading').classList.add('hidden');
            }
        };

        function renderResult(data) {
            document.getElementById('output').classList.remove('hidden');
            
            // SEO
            document.getElementById('seoTitle').innerText = data.seo.en_t;
            document.getElementById('seoTitleZh').innerText = data.seo.zh_t;
            document.getElementById('seoDesc').innerText = data.seo.en_d;
            document.getElementById('seoDescZh').innerText = data.seo.zh_d;

            // Titles
            document.getElementById('titleContainer').innerHTML = (data.titles || []).map(t => `
                <div class="card p-4">
                    <div class="text-[8px] font-black text-indigo-400 uppercase tracking-widest mb-1">${t.label}</div>
                    <div class="text-sm font-bold text-slate-800">${t.en}</div>
                    <div class="text-[11px] text-slate-400 italic mt-1">${t.zh}</div>
                </div>
            `).join('');

            // Description
            const d = data.desc;
            document.getElementById('descFullEn').innerHTML = `
                <p>${d.en_m}</p>
                <p><b>Fabric:</b> ${d.en_f}</p>
                <p><b>Model info:</b> ${d.en_i}</p>
            `;
            document.getElementById('descFullZh').innerHTML = `
                <p>${d.zh_m}</p>
                <p>面料: ${d.zh_f}</p>
                <p>模特: ${d.zh_i}</p>
            `;

            // Colors
            document.getElementById('colorContainer').innerHTML = (data.colors || []).map(c => `
                <div class="flex flex-col items-center">
                    <div class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-xs font-bold text-slate-700">${c.en}</div>
                    <div class="text-[10px] text-slate-400 mt-1">${c.zh}</div>
                </div>
            `).join('');

            // UGC Grid
            document.getElementById('ugcGrid').innerHTML = ugcPrompts.map((p, i) => `
                <div class="image-grid-item flex flex-col items-center justify-center border-2 border-dashed border-slate-200 text-slate-300" id="ugc-card-${i}">
                    <i class="fas fa-user-circle text-2xl mb-1"></i>
                    <span class="text-[8px] font-bold uppercase">${p.ethnicity}</span>
                </div>
            `).join('');
        }

        // --- UGC Logic ---
        document.getElementById('generateUgcBtn').onclick = async () => {
            const btn = document.getElementById('generateUgcBtn');
            const status = document.getElementById('ugcStatus');
            btn.disabled = true;
            status.classList.remove('hidden');
            status.innerText = "AI 正在生成高清买家秀...";

            for (let i = 0; i < ugcPrompts.length; i++) {
                const card = document.getElementById(`ugc-card-${i}`);
                card.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-slate-50 animate-pulse"><i class="fas fa-circle-notch fa-spin text-indigo-300"></i></div>`;
                
                try {
                    const res = await apiCall('gemini-2.5-flash-image-preview', {
                        contents: [{
                            parts: [
                                { inlineData: { mimeType: uploadedImages[0].mimeType, data: uploadedImages[0].base64 } },
                                { text: `Product UGC photo. Style: ${ugcPrompts[i].prompt}. Keep garment color and texture 100% consistent.` }
                            ]
                        }],
                        generationConfig: { responseModalities: ["IMAGE"] }
                    });
                    
                    const base64 = res.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
                    card.innerHTML = `<img src="data:image/png;base64,${base64}">
                        <div class="image-overlay">
                            <button onclick="window.open(this.previousElementSibling.src)" class="text-white text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/40">预览</button>
                        </div>`;
                } catch (e) {
                    card.innerHTML = `<div class="text-[8px] text-red-300 px-2 text-center">失败</div>`;
                }
            }
            status.innerText = "生成完成！";
            btn.disabled = false;
        };

        // --- Helpers ---
        function copyElementText(id, btn) {
            const el = document.getElementById(id);
            const text = el.innerText;
            const temp = document.createElement('textarea');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            const original = btn.innerText;
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = original, 2000);
        }

        function exportData() {
            if (!currentData) return;
            const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Shopify_Content_${new Date().getTime()}.json`;
            a.click();
        }
    </script>
</body>
</html>
