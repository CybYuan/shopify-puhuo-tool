<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify AI Content Pro - Dual Engine Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; transition: all 0.2s; }
        .card:hover { border-color: #cbd5e1; }
        .loading-shimmer {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .image-grid-item { aspect-ratio: 1/1; overflow: hidden; position: relative; border-radius: 0.75rem; background: #f1f5f9; border: 1px solid #e2e8f0; }
        .image-grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .image-grid-item:hover .image-overlay { opacity: 1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-900 pb-20">

    <div class="max-w-5xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-bolt-lightning text-amber-500"></i> Shopify AI Content Pro
                </h1>
                <p class="text-slate-500 text-xs font-medium">双引擎驱动：Gemini 2.5 (文案) + Nano Banana (视觉)</p>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleSettings()" class="p-2.5 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-indigo-600 hover:border-indigo-200 transition-all shadow-sm">
                    <i class="fas fa-sliders text-lg"></i>
                </button>
            </div>
        </header>

        <!-- API Settings Panel -->
        <div id="settingsPanel" class="hidden mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Text Engine Settings -->
            <div class="p-6 card border-indigo-100 bg-indigo-50/30">
                <h3 class="text-sm font-bold text-indigo-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-font"></i> 文案引擎 (Gemini 2.5 Flash)
                </h3>
                <div class="space-y-3">
                    <input id="textApiKey" type="password" placeholder="API Key (默认环境)" class="w-full px-4 py-2 rounded-lg border border-indigo-100 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                    <input id="textApiBase" type="text" placeholder="Proxy Base URL (可选)" class="w-full px-4 py-2 rounded-lg border border-indigo-100 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
            </div>
            <!-- Visual Engine Settings -->
            <div class="p-6 card border-amber-100 bg-amber-50/30">
                <h3 class="text-sm font-bold text-amber-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-image"></i> 视觉引擎 (Nano Banana)
                </h3>
                <div class="space-y-3">
                    <input id="imageApiKey" type="password" placeholder="API Key (默认环境)" class="w-full px-4 py-2 rounded-lg border border-amber-100 focus:ring-2 focus:ring-amber-500 outline-none text-sm">
                    <input id="imageApiBase" type="text" placeholder="Proxy Base URL (可选)" class="w-full px-4 py-2 rounded-lg border border-amber-100 focus:ring-2 focus:ring-amber-500 outline-none text-sm">
                </div>
            </div>
            <div class="md:col-span-2">
                <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-3 rounded-xl text-sm font-bold hover:bg-black transition-all">保存所有引擎配置</button>
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: Inputs -->
            <div class="lg:col-span-4 space-y-6">
                <div class="card p-5">
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-3">1. 产品视觉素材</label>
                    <div id="dropZone" class="relative">
                        <label for="imageInput" class="flex flex-col items-center justify-center w-full h-40 border-2 border-slate-200 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-slate-100 hover:border-indigo-300 transition-all group">
                            <div class="flex flex-col items-center justify-center text-center px-4" id="uploadPlaceholder">
                                <i class="fas fa-images text-2xl text-slate-300 group-hover:text-indigo-500 mb-2 transition-colors"></i>
                                <p class="text-[11px] text-slate-400 font-bold uppercase tracking-tight">点击或拖入主图</p>
                            </div>
                            <input id="imageInput" type="file" class="hidden" accept="image/*" multiple />
                        </label>
                    </div>
                    <div id="imagePreviews" class="flex gap-2 overflow-x-auto no-scrollbar mt-3 pb-1"></div>
                </div>

                <div class="card p-5">
                    <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-3">2. 文案微调 (Optional)</label>
                    <textarea id="rawInput" rows="6" placeholder="品牌名、面料成分、特定风格需求..." class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none text-sm leading-relaxed bg-slate-50/50"></textarea>
                </div>

                <button id="generateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-100 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>分析并生成双语方案</span>
                </button>
            </div>

            <!-- Right: Outputs -->
            <div class="lg:col-span-8 space-y-8">
                <!-- Status/Error -->
                <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-100 rounded-xl text-red-600 text-sm flex items-start gap-3">
                    <i class="fas fa-circle-exclamation mt-0.5"></i>
                    <div class="flex-1">
                        <p class="font-bold">引擎响应错误</p>
                        <p id="errorText" class="text-xs mt-1 opacity-80"></p>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loading" class="hidden space-y-6">
                    <div class="loading-shimmer h-40 rounded-xl"></div>
                    <div class="loading-shimmer h-64 rounded-xl"></div>
                </div>

                <!-- Main Content Output -->
                <div id="output" class="hidden space-y-6">
                    <!-- Tabs/Actions -->
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold text-slate-800">生成结果</h2>
                        <button onclick="exportData()" class="px-4 py-2 text-xs font-bold text-slate-500 hover:text-indigo-600 border border-slate-200 rounded-lg bg-white flex items-center gap-2 transition-all">
                            <i class="fas fa-download"></i> 导出 JSON
                        </button>
                    </div>

                    <!-- SEO Section -->
                    <div class="card overflow-hidden">
                        <div class="bg-indigo-600 px-5 py-2.5 flex justify-between items-center">
                            <span class="text-[10px] font-black text-white uppercase tracking-tighter">SEO Optimization</span>
                            <button onclick="copyText('seoContent')" class="text-[10px] text-white/80 hover:text-white uppercase font-bold">Copy All</button>
                        </div>
                        <div class="p-5 space-y-4" id="seoContent">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Meta Title</label>
                                    <p id="seoTitle" class="text-sm font-bold text-slate-800"></p>
                                    <p id="seoTitleZh" class="text-[11px] text-slate-400 mt-1 italic"></p>
                                </div>
                                <div>
                                    <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Meta Description</label>
                                    <p id="seoDesc" class="text-xs text-slate-600 leading-relaxed"></p>
                                    <p id="seoDescZh" class="text-[11px] text-slate-400 mt-1 italic"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Titles -->
                    <div id="titleContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

                    <!-- Description -->
                    <div class="card overflow-hidden">
                        <div class="bg-slate-800 px-5 py-2.5 flex justify-between items-center">
                            <span class="text-[10px] font-black text-white uppercase tracking-tighter">Product Story & Specs</span>
                            <button onclick="copyText('descEn')" class="text-[10px] text-white/80 hover:text-white uppercase font-bold">Copy English</button>
                        </div>
                        <div class="p-6">
                            <div id="descEn" class="text-sm text-slate-700 leading-relaxed space-y-3"></div>
                            <div id="descZh" class="mt-6 pt-6 border-t border-slate-100 text-[13px] text-slate-400 italic space-y-2"></div>
                        </div>
                    </div>

                    <!-- Colors -->
                    <div id="colorContainer" class="flex flex-wrap gap-3"></div>

                    <!-- Visual UGC Section -->
                    <div class="pt-6 border-t border-slate-200">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight">Consistent Visual UGC</h3>
                                <p class="text-[10px] text-slate-400">由 Nano Banana 视觉引擎基于产品原图生成的买家秀图库</p>
                            </div>
                            <button id="generateUgcBtn" class="bg-amber-500 text-white px-5 py-2.5 rounded-full text-xs font-black shadow-lg shadow-amber-100 hover:bg-amber-600 transition-all flex items-center gap-2">
                                <i class="fas fa-camera-retro"></i> 生成高清图库
                            </button>
                        </div>
                        <div id="ugcGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3"></div>
                        <p id="ugcStatus" class="mt-4 text-[10px] text-slate-400 text-center font-medium italic hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & Initialization ---
        let currentData = null;
        let uploadedImages = [];
        let ugcPrompts = [];
        const apiKey = ""; // 运行时注入

        window.onload = () => {
            const configs = ['textApiKey', 'textApiBase', 'imageApiKey', 'imageApiBase'];
            configs.forEach(id => {
                const saved = localStorage.getItem(id);
                if (saved) document.getElementById(id).value = saved;
            });
        };

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function saveSettings() {
            const configs = ['textApiKey', 'textApiBase', 'imageApiKey', 'imageApiBase'];
            configs.forEach(id => localStorage.setItem(id, document.getElementById(id).value.trim()));
            toggleSettings();
            showMessage("配置已成功更新");
        }

        // --- Network Wrapper with Exponential Backoff ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status === 429) { // Rate limit
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(r => setTimeout(r, delay));
                        continue;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        // --- Engine Call Logic ---
        async function callEngine(type, payload) {
            const isText = type === 'text';
            const engineKey = document.getElementById(isText ? 'textApiKey' : 'imageApiKey').value || apiKey;
            const engineBase = document.getElementById(isText ? 'textApiBase' : 'imageApiBase').value || "https://generativelanguage.googleapis.com";
            const model = isText ? 'gemini-2.5-flash-preview-09-2025' : 'gemini-2.5-flash-image-preview';
            
            const cleanBase = engineBase.endsWith('/') ? engineBase.slice(0, -1) : engineBase;
            const url = `${cleanBase}/v1beta/models/${model}:generateContent?key=${engineKey}`;

            return await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        // --- File Handling ---
        const imageInput = document.getElementById('imageInput');
        imageInput.onchange = e => Array.from(e.target.files).forEach(processFile);

        function processFile(file) {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedImages.push({ base64: e.target.result.split(',')[1], mimeType: file.type });
                updatePreviews();
            };
            reader.readAsDataURL(file);
        }

        function updatePreviews() {
            document.getElementById('uploadPlaceholder').classList.toggle('hidden', uploadedImages.length > 0);
            document.getElementById('imagePreviews').innerHTML = uploadedImages.map((img, i) => `
                <div class="relative w-16 h-16 rounded-lg overflow-hidden border border-slate-200 shrink-0 shadow-sm">
                    <img src="data:${img.mimeType};base64,${img.base64}" class="w-full h-full object-cover">
                    <button onclick="uploadedImages.splice(${i},1);updatePreviews();" class="absolute top-0 right-0 bg-red-500/80 text-white w-4 h-4 flex items-center justify-center text-[8px]">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- Main Generation Flow ---
        document.getElementById('generateBtn').onclick = async () => {
            if (uploadedImages.length === 0) return showMessage("请至少上传一张产品图片", "error");

            const btn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');
            const output = document.getElementById('output');
            const errorBox = document.getElementById('errorMessage');

            btn.disabled = true;
            loading.classList.remove('hidden');
            output.classList.add('hidden');
            errorBox.classList.add('hidden');

            const systemPrompt = `You are an elite Shopify product strategist.
Goal: Create high-converting bilingual (English/Chinese) product listings.
Deliverables: SEO meta, catchy titles, immersive descriptions, and UGC prompts.

Structure for Description:
- "The Story": Emotional hook, fit, and silhouette.
- "The Fabric": Technical breakdown.
- "Size Ref": Realistic model metrics.

JSON OUTPUT SCHEMA:
{
  "seo": { "en_t": "...", "zh_t": "...", "en_d": "...", "zh_d": "..." },
  "titles": [{"tag": "SEO-READY", "en": "...", "zh": "..."}],
  "desc": { "en_s": "Story...", "en_f": "Fabric...", "en_r": "Ref...", "zh_s": "...", "zh_f": "...", "zh_r": "..." },
  "colors": [{"en": "Sandstone", "zh": "磨砂金"}],
  "ugc": [{"scene": "Street Style", "prompt": "Outdoor street photography style..."}]
}`;

            const parts = [{ text: document.getElementById('rawInput').value.trim() || "Analyze this product in detail." }];
            uploadedImages.forEach(img => parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } }));

            try {
                const response = await callEngine('text', {
                    contents: [{ parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                });

                const rawText = response.candidates?.[0]?.content?.parts?.[0]?.text;
                const result = JSON.parse(rawText);
                currentData = result;
                ugcPrompts = result.ugc || [];
                renderResults(result);
            } catch (err) {
                document.getElementById('errorText').innerText = err.message;
                errorBox.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
            }
        };

        function renderResults(data) {
            document.getElementById('output').classList.remove('hidden');
            
            // SEO
            document.getElementById('seoTitle').innerText = data.seo.en_t;
            document.getElementById('seoTitleZh').innerText = data.seo.zh_t;
            document.getElementById('seoDesc').innerText = data.seo.en_d;
            document.getElementById('seoDescZh').innerText = data.seo.zh_d;

            // Titles
            document.getElementById('titleContainer').innerHTML = data.titles.map(t => `
                <div class="card p-4">
                    <span class="text-[8px] font-black text-indigo-400 bg-indigo-50 px-1.5 py-0.5 rounded mb-2 inline-block uppercase tracking-widest">${t.tag}</span>
                    <h4 class="text-sm font-bold text-slate-800 leading-tight">${t.en}</h4>
                    <p class="text-[11px] text-slate-400 italic mt-2">${t.zh}</p>
                </div>
            `).join('');

            // Description
            document.getElementById('descEn').innerHTML = `
                <p>${data.desc.en_s}</p>
                <p><strong>Fabric:</strong> ${data.desc.en_f}</p>
                <p><strong>Model:</strong> ${data.desc.en_r}</p>
            `;
            document.getElementById('descZh').innerHTML = `
                <p>${data.desc.zh_s}</p>
                <p>材质: ${data.desc.zh_f}</p>
                <p>尺码信息: ${data.desc.zh_r}</p>
            `;

            // Colors
            document.getElementById('colorContainer').innerHTML = data.colors.map(c => `
                <div class="bg-white border border-slate-200 px-3 py-1.5 rounded-full shadow-sm flex items-center gap-2">
                    <span class="text-[11px] font-bold text-slate-700">${c.en}</span>
                    <span class="text-[9px] text-slate-300">|</span>
                    <span class="text-[10px] text-slate-400">${c.zh}</span>
                </div>
            `).join('');

            // UGC Grid Init
            document.getElementById('ugcGrid').innerHTML = ugcPrompts.map((p, i) => `
                <div class="image-grid-item flex flex-col items-center justify-center border-dashed border-2 border-slate-100 text-slate-200" id="ugc-box-${i}">
                    <i class="fas fa-camera text-xl mb-1"></i>
                    <span class="text-[8px] font-black uppercase">${p.scene}</span>
                </div>
            `).join('');
        }

        // --- Visual Engine Logic (Nano Banana) ---
        document.getElementById('generateUgcBtn').onclick = async () => {
            const btn = document.getElementById('generateUgcBtn');
            const status = document.getElementById('ugcStatus');
            btn.disabled = true;
            status.classList.remove('hidden');
            status.innerText = "视觉引擎正在合成高清买家秀图片...";

            const baseImg = uploadedImages[0];

            for (let i = 0; i < ugcPrompts.length; i++) {
                const box = document.getElementById(`ugc-box-${i}`);
                box.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center bg-slate-50 animate-pulse"><i class="fas fa-spinner fa-spin text-amber-300 mb-1"></i><span class="text-[8px] text-amber-400 uppercase font-black">Rendering</span></div>`;
                
                try {
                    const res = await callEngine('image', {
                        contents: [{
                            parts: [
                                { inlineData: { mimeType: baseImg.mimeType, data: baseImg.base64 } },
                                { text: `High quality UGC/lifestyle photo. The person is wearing the exact same garment from the reference image. Style: ${ugcPrompts[i].prompt}. Photorealistic, 4k, natural lighting.` }
                            ]
                        }],
                        generationConfig: { responseModalities: ["IMAGE"] }
                    });
                    
                    const imgData = res.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                    if (imgData) {
                        box.innerHTML = `
                            <img src="data:image/png;base64,${imgData}">
                            <div class="image-overlay">
                                <button onclick="window.open(this.parentElement.previousElementSibling.src)" class="text-white text-[10px] font-black bg-black/40 px-3 py-1.5 rounded-full hover:bg-black/60 transition-all">PREVIEW</button>
                            </div>
                        `;
                    } else {
                        throw new Error("No image data");
                    }
                } catch (e) {
                    box.innerHTML = `<div class="text-[8px] text-red-300 font-bold px-2 text-center">FAILED TO RENDER</div>`;
                }
            }
            status.innerText = "视觉引擎图库生成完成！";
            btn.disabled = false;
        };

        // --- Utils ---
        function showMessage(text, type = "info") {
            // Simple message box instead of alert
            const msg = document.createElement('div');
            msg.className = `fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-xs font-bold shadow-xl z-50 transition-all transform translate-y-20 ${type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-900 text-white'}`;
            msg.innerText = text;
            document.body.appendChild(msg);
            setTimeout(() => { msg.classList.remove('translate-y-20'); }, 10);
            setTimeout(() => { 
                msg.classList.add('translate-y-20');
                setTimeout(() => msg.remove(), 500);
            }, 3000);
        }

        function copyText(id) {
            const el = document.getElementById(id);
            const range = document.createRange();
            range.selectNode(el);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            showMessage("文本已复制到剪贴板");
        }

        function exportData() {
            if (!currentData) return;
            const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Shopify_AI_Pro_${Date.now()}.json`;
            a.click();
        }
    </script>
</body>
</html>
